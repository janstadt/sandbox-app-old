{"version":3,"file":"surescripts-notifications.js","sources":["ng://@surescripts/notifications/lib/notifications.service.ts","ng://@surescripts/notifications/lib/notification.model.ts","ng://@surescripts/notifications/lib/notifications.model.ts","ng://@surescripts/notifications/lib/notification-status.enum.ts","ng://@surescripts/notifications/lib/notifications.component.ts","ng://@surescripts/notifications/lib/notifications.module.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class NotificationsService {\r\n\r\n  constructor() { }\r\n}\r\n","import { SurescriptsNotificationStatus } from './notification-status.enum';\r\nexport class SurescriptsNotification {\r\n    title: string;\r\n    summary: string;\r\n    id: string;\r\n    status: SurescriptsNotificationStatus;\r\n    postedDate: Date;\r\n    readablePostedDate: string;\r\n    public constructor(init?: Partial<SurescriptsNotification>) {\r\n        Object.assign(this, init);\r\n        this.postedDate = new Date(init.postedDate);\r\n        const difference = new Date().getTime() - this.postedDate.getTime();\r\n        if (difference <= 3600000) {\r\n            const minutes = Math.round(((difference % 86400000) % 3600000) / 60000);\r\n            if (minutes < 2) {\r\n                this.readablePostedDate = 'Moments ago';\r\n            } else {\r\n                this.readablePostedDate = `${minutes} minutes ago`;\r\n            }\r\n        } else if (difference <= 86400000) {\r\n            const hours = Math.floor((difference % 86400000) / 3600000);\r\n            if (hours < 2) {\r\n                this.readablePostedDate = `${hours} hour ago`;\r\n            } else {\r\n                this.readablePostedDate = `${hours} hours ago`;\r\n            }\r\n        } else if (difference <= 604800000) {\r\n            const days = Math.floor(difference / 86400000);\r\n            if (days < 2) {\r\n                this.readablePostedDate = `${days} day ago`;\r\n            } else {\r\n                this.readablePostedDate = `${days} days ago`;\r\n            }\r\n        }\r\n    }\r\n}\r\n","import { SurescriptsNotification } from './notification.model';\r\n\r\nexport class SurescriptsNotifications {\r\n    baseUrl: string;\r\n    items: Array<SurescriptsNotification>;\r\n    total: number;\r\n    public constructor(init?: Partial<SurescriptsNotifications>) {\r\n        Object.assign(this, init);\r\n        this.items = init.items.map(x => new SurescriptsNotification(x));\r\n    }\r\n}\r\n","export enum SurescriptsNotificationStatus {\r\n    Read = 'Read',\r\n    Unread = 'Unread'\r\n}\r\n","import { Component, OnInit, Input } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { SurescriptsNotifications } from './notifications.model';\r\nimport { tap, exhaustMap, startWith, switchMap, finalize, dematerialize, materialize } from 'rxjs/operators';\r\nimport { faBell, IconDefinition } from '@fortawesome/free-solid-svg-icons';\r\nimport { SurescriptsNotification } from './notification.model';\r\nimport { SurescriptsNotificationStatus } from './notification-status.enum';\r\nimport { Observable, interval, BehaviorSubject, NEVER } from 'rxjs';\r\nimport { Router, NavigationEnd, Event } from '@angular/router';\r\n\r\n@Component({\r\n  // tslint:disable-next-line:component-selector\r\n  selector: 'surescripts-notifications',\r\n  templateUrl: './notifications.component.html',\r\n  styleUrls: ['./notifications.component.scss']\r\n})\r\nexport class NotificationsComponent implements OnInit {\r\n\r\n  faBell: IconDefinition = faBell;\r\n\r\n  @Input()\r\n  ssoBaseUrl: string;\r\n  notifications: SurescriptsNotifications;\r\n  unreadCount = 0;\r\n  SurescriptsNotificationStatus = SurescriptsNotificationStatus;\r\n  constructor(private http: HttpClient, private router: Router) { }\r\n\r\n  ngOnInit() {\r\n    if (!this.ssoBaseUrl) {\r\n      throw new Error('\"ssoBaseUrl\" is required.');\r\n    }\r\n    this.ssoBaseUrl = this.ssoBaseUrl.replace(/\\/+$/, '');\r\n\r\n    const pauser = new BehaviorSubject(false);\r\n\r\n    // poll every hour.\r\n    const source = interval(3600000).pipe(\r\n      startWith(0),\r\n      exhaustMap(() => this.poll())\r\n    );\r\n\r\n    pauser.pipe(switchMap(\r\n      paused => paused ? NEVER : source.pipe(materialize())\r\n    ), dematerialize()).subscribe();\r\n\r\n    this.router.events.subscribe((event: Event) => {\r\n      if (event instanceof NavigationEnd) {\r\n        // pause the poll and make a call. once finished, turn the poll on again and unsubscribe\r\n        pauser.next(true);\r\n        this.poll().pipe(finalize(() => {\r\n          pauser.next(false);\r\n        })).subscribe().unsubscribe();\r\n      }\r\n    });\r\n  }\r\n\r\n  private poll(): Observable<SurescriptsNotifications> {\r\n    return this.http.get<SurescriptsNotifications>(`${this.ssoBaseUrl}/app/v1/user/notifications`,\r\n    { withCredentials: true }).pipe(tap((resp: SurescriptsNotifications) => {\r\n      this.notifications = new SurescriptsNotifications(resp);\r\n      this.unreadCount = this.notifications.items.filter(x => x.status === SurescriptsNotificationStatus.Unread).length;\r\n    }));\r\n  }\r\n\r\n  itemClicked(item: SurescriptsNotification) {\r\n    if (item.status === SurescriptsNotificationStatus.Unread) {\r\n      this.http.put<SurescriptsNotification>(`${this.ssoBaseUrl}/app/v1/user/notifications/${item.id}/read`, null,\r\n      { withCredentials: true }).pipe(tap(() => {\r\n        item.status = SurescriptsNotificationStatus.Read;\r\n        this.unreadCount = this.unreadCount - 1;\r\n      })).subscribe();\r\n    }\r\n  }\r\n\r\n  dismiss($event: MouseEvent, item: SurescriptsNotification) {\r\n    const index = this.notifications.items.indexOf(item);\r\n    $event.stopPropagation();\r\n    if (index >= 0) {\r\n      this.http.put<SurescriptsNotification>(`${this.ssoBaseUrl}/app/v1/user/notifications/${item.id}/dismiss`, null,\r\n      { withCredentials: true }).pipe(tap(() => {\r\n        this.notifications.items.splice(index, 1);\r\n        if (item.status === SurescriptsNotificationStatus.Unread) {\r\n          this.unreadCount = this.unreadCount - 1;\r\n        }\r\n      })).subscribe();\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { NotificationsComponent } from './notifications.component';\r\nimport { NgbDropdownModule } from '@ng-bootstrap/ng-bootstrap';\r\nimport { FontAwesomeModule } from '@fortawesome/angular-fontawesome';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    HttpClientModule,\r\n    NgbDropdownModule,\r\n    FontAwesomeModule\r\n  ],\r\n  declarations: [NotificationsComponent],\r\n  exports: [NotificationsComponent]\r\n})\r\nexport class NotificationsModule { }\r\n\r\nexport { SurescriptsNotification } from './notification.model';\r\nexport { SurescriptsNotifications } from './notifications.model';\r\nexport { SurescriptsNotificationStatus } from './notification-status.enum';\r\n\r\n"],"names":[],"mappings":"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"}